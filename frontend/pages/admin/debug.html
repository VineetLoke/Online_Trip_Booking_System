<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Panel Debug Tool</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .test-results {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 1rem;
      margin: 1rem 0;
    }
    .success { color: #28a745; }
    .error { color: #dc3545; }
    .info { color: #17a2b8; }
  </style>
</head>
<body>
  <div class="container mt-4">
    <h2>üîß Admin Panel Debug Tool</h2>
    <p>This tool helps diagnose issues with the admin panel.</p>

    <div class="row">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Quick Admin Login</h5>
          </div>
          <div class="card-body">
            <button id="testLogin" class="btn btn-primary">Test Admin Login</button>
            <button id="clearStorage" class="btn btn-warning">Clear Storage</button>
            <button id="checkAuth" class="btn btn-info">Check Auth Status</button>
            <div id="loginResults" class="test-results"></div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>API Endpoint Tests</h5>
          </div>
          <div class="card-body">
            <button id="testEndpoints" class="btn btn-success">Test All Endpoints</button>
            <div id="apiResults" class="test-results"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5>Logout Button Tests</h5>
      </div>
      <div class="card-body">
        <button id="testLogout1" class="btn btn-danger">Test Sidebar Logout</button>
        <button id="testLogout2" class="btn btn-danger">Test Dropdown Logout</button>
        <div id="logoutResults" class="test-results"></div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">
        <h5>System Information</h5>
      </div>
      <div class="card-body">
        <div id="systemInfo" class="test-results"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_BASE_URL = 'http://localhost:3000/api';
    
    // Utility functions
    function log(elementId, message, type = 'info') {
      const element = document.getElementById(elementId);
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
      element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
    }

    function clearLog(elementId) {
      document.getElementById(elementId).innerHTML = '';
    }

    // Test admin login
    document.getElementById('testLogin').addEventListener('click', async () => {
      clearLog('loginResults');
      log('loginResults', 'Testing admin login...', 'info');
      
      try {
        const response = await fetch(`${API_BASE_URL}/auth/admin/login`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            email: 'admin@travelease.com',
            password: 'admin123'
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          localStorage.setItem('adminToken', data.token);
          localStorage.setItem('adminUser', JSON.stringify(data.admin));
          log('loginResults', '‚úÖ Admin login successful', 'success');
          log('loginResults', `Admin: ${data.admin.name} (${data.admin.role})`, 'success');
        } else {
          log('loginResults', `‚ùå Login failed: ${data.error?.message || data.message}`, 'error');
        }
      } catch (error) {
        log('loginResults', `‚ùå Login error: ${error.message}`, 'error');
      }
    });

    // Clear storage
    document.getElementById('clearStorage').addEventListener('click', () => {
      clearLog('loginResults');
      localStorage.removeItem('adminToken');
      localStorage.removeItem('adminUser');
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      log('loginResults', 'üóëÔ∏è Local storage cleared', 'info');
    });

    // Check auth status
    document.getElementById('checkAuth').addEventListener('click', () => {
      clearLog('loginResults');
      const adminToken = localStorage.getItem('adminToken');
      const adminUser = localStorage.getItem('adminUser');
      
      if (adminToken) {
        log('loginResults', '‚úÖ Admin token found', 'success');
        if (adminUser) {
          const user = JSON.parse(adminUser);
          log('loginResults', `Admin: ${user.name} (${user.email})`, 'success');
        }
      } else {
        log('loginResults', '‚ùå No admin token found', 'error');
      }
    });

    // Test API endpoints
    document.getElementById('testEndpoints').addEventListener('click', async () => {
      clearLog('apiResults');
      const adminToken = localStorage.getItem('adminToken');
      
      if (!adminToken) {
        log('apiResults', '‚ùå No admin token - login first', 'error');
        return;
      }

      const endpoints = [
        '/admin/users',
        '/admin/flights', 
        '/admin/trains',
        '/admin/hotels',
        '/admin/bookings'
      ];

      for (const endpoint of endpoints) {
        try {
          const response = await fetch(`${API_BASE_URL}${endpoint}`, {
            headers: {
              'Authorization': `Bearer ${adminToken}`,
              'Content-Type': 'application/json'
            }
          });
          
          const data = await response.json();
          
          if (response.ok) {
            log('apiResults', `‚úÖ ${endpoint}: ${data.count || 0} items`, 'success');
          } else {
            log('apiResults', `‚ùå ${endpoint}: ${data.error?.message || data.message}`, 'error');
          }
        } catch (error) {
          log('apiResults', `‚ùå ${endpoint}: ${error.message}`, 'error');
        }
      }
    });

    // Test logout buttons
    document.getElementById('testLogout1').addEventListener('click', () => {
      clearLog('logoutResults');
      log('logoutResults', 'Testing sidebar logout button...', 'info');
      
      // Simulate clicking the sidebar logout button
      if (typeof window.adminLogout === 'function') {
        log('logoutResults', '‚úÖ window.adminLogout function found', 'success');
        try {
          window.adminLogout();
          log('logoutResults', '‚úÖ Logout function executed', 'success');
        } catch (error) {
          log('logoutResults', `‚ùå Logout error: ${error.message}`, 'error');
        }
      } else {
        log('logoutResults', '‚ùå window.adminLogout function not found', 'error');
      }
    });

    document.getElementById('testLogout2').addEventListener('click', () => {
      clearLog('logoutResults');
      log('logoutResults', 'Testing dropdown logout button...', 'info');
      
      // Test fallback logout
      try {
        localStorage.removeItem('adminToken');
        localStorage.removeItem('adminUser');
        log('logoutResults', '‚úÖ Tokens cleared successfully', 'success');
        log('logoutResults', '‚ÑπÔ∏è Should redirect to login.html', 'info');
      } catch (error) {
        log('logoutResults', `‚ùå Logout error: ${error.message}`, 'error');
      }
    });

    // System information
    function updateSystemInfo() {
      const systemInfo = document.getElementById('systemInfo');
      systemInfo.innerHTML = `
        <div><strong>Current URL:</strong> ${window.location.href}</div>
        <div><strong>User Agent:</strong> ${navigator.userAgent}</div>
        <div><strong>Local Storage Keys:</strong> ${Object.keys(localStorage).join(', ')}</div>
        <div><strong>Admin Token Present:</strong> ${localStorage.getItem('adminToken') ? 'Yes' : 'No'}</div>
        <div><strong>Admin User Present:</strong> ${localStorage.getItem('adminUser') ? 'Yes' : 'No'}</div>
        <div><strong>Console Errors:</strong> Check browser dev tools (F12)</div>
      `;
    }

    // Update system info on page load
    updateSystemInfo();

    // Refresh system info every 5 seconds
    setInterval(updateSystemInfo, 5000);
  </script>
</body>
</html>
